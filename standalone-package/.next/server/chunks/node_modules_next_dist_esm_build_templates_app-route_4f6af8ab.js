module.exports=[70381,e=>{"use strict";e.s(["handler",()=>C,"patchFetch",()=>D,"routeModule",()=>A,"serverHooks",()=>k,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>O],70381);var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),o=e.i(61916),s=e.i(69741),i=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),d=e.i(66012),p=e.i(70101),m=e.i(26937),h=e.i(10372),g=e.i(93695);e.i(52474);var w=e.i(220);e.s(["GET",()=>f],30711);var E=e.i(89171),R=e.i(15270),y=e.i(68105);let _=["NEW","IN_PROGRESS","ON_HOLD","DONE","CANCEL"];async function f(e){try{let t=e.cookies.get("auth-token")?.value;if(!t)return E.NextResponse.json({error:"Unauthorized"},{status:401});let a=await (0,y.getSession)(t);if(!a||"USER"===a.role)return E.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:r}=new URL(e.url),n=r.get("from"),o=r.get("to"),s=r.get("type");if("IT"===s&&"ADMIN"!==a.role&&"IT_ADMIN"!==a.role||"ENGINEER"===s&&"ADMIN"!==a.role&&"ENGINEER_ADMIN"!==a.role||!s&&"ADMIN"!==a.role)return E.NextResponse.json({error:"Forbidden"},{status:403});let i={};n&&o&&(i.createdAt={gte:new Date(n),lte:new Date(o+"T23:59:59.999Z")});let l=new Date,u=new Date(l.getFullYear(),l.getMonth(),1),c=new Date(l);c.setDate(l.getDate()-30);let d=new Date(l.getFullYear(),l.getMonth()-1,1),p=new Date(l.getFullYear(),l.getMonth(),0,23,59,59,999),m=new Date(l.getFullYear(),0,1),h=0,g=0,w=0,f=0,N=0,A=0,v=0,O=0,k=[],D=[],C=[],T=[],x=[],b=[],I=[],M=[],S=[],P=[],U=[],B=[],H=[];"IT"!==s&&s||([h,w,N,v,k,C,x,I,S]=await Promise.all([R.prisma.ticket.count({where:n&&o?i:{createdAt:{gte:m}}}),R.prisma.ticket.count({where:{status:"DONE",updatedAt:{gte:u}}}),R.prisma.ticket.count({where:{status:"DONE",updatedAt:{gte:d,lte:p}}}),R.prisma.ticket.count({where:{createdAt:{gte:m}}}),R.prisma.ticket.findMany({where:i.createdAt?i:{createdAt:{gte:c}},select:{userId:!0}}),R.prisma.ticket.findMany({where:{...i,status:"DONE"},select:{createdAt:!0,updatedAt:!0}}),R.prisma.ticket.groupBy({by:["status"],_count:{_all:!0},where:i}),R.prisma.ticket.groupBy({by:["typeOfDamage"],_count:{_all:!0},where:i}),R.prisma.ticket.groupBy({by:["department","status"],_count:{_all:!0},where:i})])),"ENGINEER"!==s&&s||([g,f,A,O,D,T,b,M,P,U,B,H]=await Promise.all([R.prisma.engineerTicket.count({where:n&&o?i:{createdAt:{gte:m}}}),R.prisma.engineerTicket.count({where:{status:"DONE",updatedAt:{gte:u}}}),R.prisma.engineerTicket.count({where:{status:"DONE",updatedAt:{gte:d,lte:p}}}),R.prisma.engineerTicket.count({where:{createdAt:{gte:m}}}),R.prisma.engineerTicket.findMany({where:i.createdAt?i:{createdAt:{gte:c}},select:{userId:!0}}),R.prisma.engineerTicket.findMany({where:{...i,status:"DONE"},select:{createdAt:!0,updatedAt:!0}}),R.prisma.engineerTicket.groupBy({by:["status"],_count:{_all:!0},where:i}),R.prisma.engineerTicket.groupBy({by:["typeOfDamage"],_count:{_all:!0},where:i}),R.prisma.engineerTicket.groupBy({by:["location"],_count:{_all:!0},where:i}),R.prisma.engineerTicket.groupBy({by:["informationBy"],_count:{_all:!0},where:i}),R.prisma.engineerTicket.groupBy({by:["department"],_count:{_all:!0},where:i}),R.prisma.engineerTicket.groupBy({by:["department","status"],_count:{_all:!0},where:i})]));let F=h+g,j=w+f,q=N+A,L=v+O,G=new Set([...k.map(e=>e.userId),...D.map(e=>e.userId)]).size,$=[...C,...T].filter(e=>e.updatedAt).map(e=>(e.updatedAt.getTime()-e.createdAt.getTime())/36e5),K=$.length?Number(($.reduce((e,t)=>e+t,0)/$.length).toFixed(1)):null,W=new Map;x.forEach(e=>{W.set(e.status,(W.get(e.status)||0)+e._count._all)}),b.forEach(e=>{W.set(e.status,(W.get(e.status)||0)+e._count._all)});let Y=_.map(e=>({status:e,count:W.get(e)||0})),z=new Map;I.forEach(e=>{let t=e.typeOfDamage||"Other";z.set(t,(z.get(t)||0)+e._count._all)}),M.forEach(e=>{let t=e.typeOfDamage||"Other";z.set(t,(z.get(t)||0)+e._count._all)});let V=Array.from(z.entries()).map(([e,t])=>({type:e,count:t})).sort((e,t)=>t.count-e.count),X=new Map;S.forEach(e=>{let t=e.department||"Unknown",a=e.status;X.has(t)||X.set(t,{NEW:0,IN_PROGRESS:0,ON_HOLD:0,DONE:0,CANCEL:0}),X.get(t)[a]=e._count._all});let Z=Array.from(X.entries()).map(([e,t])=>({department:e,...t,total:Object.values(t).reduce((e,t)=>e+t,0)})).sort((e,t)=>t.total-e.total),J=new Map;H.forEach(e=>{let t=e.department||"Unknown",a=e.status;J.has(t)||J.set(t,{NEW:0,IN_PROGRESS:0,ON_HOLD:0,DONE:0,CANCEL:0}),J.get(t)[a]=e._count._all});let Q=Array.from(J.entries()).map(([e,t])=>({department:e,...t,total:Object.values(t).reduce((e,t)=>e+t,0)})).sort((e,t)=>t.total-e.total);return E.NextResponse.json({success:!0,data:{totalTickets:F,thisMonthTickets:j,lastMonthTickets:q,yearToDateTickets:L,activeUsers:G,avgResolutionHours:K,statusBreakdown:Y,typeBreakdown:V,locationBreakdown:P.map(e=>({name:e.location||"Unknown",count:e._count._all})).sort((e,t)=>t.count-e.count),informationByBreakdown:U.map(e=>({name:e.informationBy||"Unknown",count:e._count._all})).sort((e,t)=>t.count-e.count),departmentBreakdown:B.map(e=>({name:e.department||"Unknown",count:e._count._all})).sort((e,t)=>t.count-e.count),departmentStatusBreakdown:Q,itDepartmentStatusBreakdown:Z}})}catch(e){return console.error("Summary stats error:",e),E.NextResponse.json({error:"Internal server error"},{status:500})}}var N=e.i(30711);let A=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/stats/summary/route",pathname:"/api/stats/summary",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/stats/summary/route.ts",nextConfigOutput:"standalone",userland:N}),{workAsyncStorage:v,workUnitAsyncStorage:O,serverHooks:k}=A;function D(){return(0,r.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:O})}async function C(e,t,r){var E;let R="/api/stats/summary/route";R=R.replace(/\/index$/,"")||"/";let y=await A.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:_,params:f,nextConfig:N,isDraftMode:v,prerenderManifest:O,routerServerContext:k,isOnDemandRevalidate:D,revalidateOnlyGenerated:C,resolvedPathname:T}=y,x=(0,s.normalizeAppPath)(R),b=!!(O.dynamicRoutes[x]||O.routes[T]);if(b&&!v){let e=!!O.routes[T],t=O.dynamicRoutes[x];if(t&&!1===t.fallback&&!e)throw new g.NoFallbackError}let I=null;!b||A.isDev||v||(I="/index"===(I=T)?"/":I);let M=!0===A.isDev||!b,S=b&&!M,P=e.method||"GET",U=(0,o.getTracer)(),B=U.getActiveScopeSpan(),H={params:f,prerenderManifest:O,renderOpts:{experimental:{cacheComponents:!!N.experimental.cacheComponents,authInterrupts:!!N.experimental.authInterrupts},supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(E=N.experimental)?void 0:E.cacheLife,isRevalidate:S,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>A.onRequestError(e,t,r,k)},sharedContext:{buildId:_}},F=new i.NodeNextRequest(e),j=new i.NodeNextResponse(t),q=l.NextRequestAdapter.fromNodeNextRequest(F,(0,l.signalFromNodeResponse)(t));try{let s=async a=>A.handle(q,H).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let e=`${P} ${n}`;a.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),a.updateName(e)}else a.updateName(`${P} ${e.url}`)}),i=async o=>{var i,l;let u=async({previousCacheEntry:a})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&D&&C&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(o);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=H.renderOpts.collectedTags;if(!b)return await (0,d.sendResponse)(F,j,i,H.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:S,isOnDemandRevalidate:D})},k),t}},g=await A.handleResponse({req:e,nextConfig:N,cacheKey:I,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:r.waitUntil});if(!b)return null;if((null==g||null==(i=g.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==g||null==(l=g.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",D?"REVALIDATED":g.isMiss?"MISS":g.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let E=(0,p.fromNodeOutgoingHttpHeaders)(g.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&b||E.delete(h.NEXT_CACHE_TAGS_HEADER),!g.cacheControl||t.getHeader("Cache-Control")||E.get("Cache-Control")||E.set("Cache-Control",(0,m.getCacheControlHeader)(g.cacheControl)),await (0,d.sendResponse)(F,j,new Response(g.value.body,{headers:E,status:g.value.status||200})),null};B?await i(B):await U.withPropagatedContext(e.headers,()=>U.trace(u.BaseServerSpan.handleRequest,{spanName:`${P} ${e.url}`,kind:o.SpanKind.SERVER,attributes:{"http.method":P,"http.target":e.url}},i))}catch(t){if(B||t instanceof g.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:S,isOnDemandRevalidate:D})}),b)throw t;return await (0,d.sendResponse)(F,j,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_4f6af8ab.js.map