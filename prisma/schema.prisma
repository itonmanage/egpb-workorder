// Prisma Schema for EGPB Ticket Management System
// Migrated from Supabase to PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id                 String    @id @default(uuid()) @db.Uuid
  username           String    @unique
  fullName           String?   @map("full_name")
  position           String?
  department         String?
  telephoneExtension String?   @map("telephone_extension")
  password           String
  role               UserRole  @default(USER)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Account Security
  isLocked           Boolean   @default(false) @map("is_locked")
  lockedAt           DateTime? @map("locked_at")
  failedAttempts     Int       @default(0) @map("failed_attempts")
  lastFailedAt       DateTime? @map("last_failed_at")

  // Relations
  tickets                  Ticket[]
  engineerTickets          EngineerTicket[]
  ticketViews              TicketView[]
  engineerTicketViews      EngineerTicketView[]
  ticketComments           TicketComment[]
  engineerTicketComments   EngineerTicketComment[]
  ticketActivities         TicketActivity[]
  engineerTicketActivities EngineerTicketActivity[]
  sessions                 Session[]
  userActivities           UserActivity[]
  notifications            Notification[]

  @@map("users")
}

enum UserRole {
  ADMIN
  IT_ADMIN
  ENGINEER_ADMIN
  USER
  EXE_AC       // Executive & Accounting
  FB           // F&B
  BANQUET      // Banquet
  FRONT_OFFICE // Front Office
  HK           // Housekeeping
  HR           // Human Resources
  JURISTIC     // Juristic
  KITCHEN      // Kitchen
  RSVN_SALE    // Reservation & Sales & Marketing
  SEC          // Security
  ENG          // Engineer

  @@map("user_role")
}


model Session {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============================================
// IT Tickets
// ============================================

model Ticket {
  id            String       @id @default(uuid()) @db.Uuid
  ticketNumber  String       @unique @map("ticket_number")
  title         String?
  description   String?      @db.Text
  department    String?
  location      String?
  typeOfDamage  String       @map("type_of_damage")
  status        TicketStatus @default(NEW)
  adminNotes    String?      @map("admin_notes") @db.Text
  assignTo      String?      @map("assign_to")
  userId        String       @map("user_id") @db.Uuid
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  images         TicketImage[]
  views          TicketView[]
  comments       TicketComment[]
  activities     TicketActivity[]

  @@index([userId])
  @@index([status])
  @@index([ticketNumber])
  @@index([createdAt(sort: Desc)])
  @@map("tickets")
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  ON_HOLD
  DONE
  CANCEL

  @@map("ticket_status")
}

model TicketImage {
  id           String   @id @default(uuid()) @db.Uuid
  ticketId     String   @map("ticket_id") @db.Uuid
  imageUrl     String   @map("image_url")
  uploadedBy   String   @map("uploaded_by")
  isCompletion Boolean  @default(false) @map("is_completion")
  createdAt    DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_images")
}

model TicketView {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  viewedAt  DateTime @default(now()) @map("viewed_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ticketId, userId])
  @@index([userId])
  @@map("ticket_views")
}

model TicketComment {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  comment   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@map("ticket_comments")
}

model TicketActivity {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @map("ticket_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  actionType  String   @map("action_type")
  oldValue    String?  @map("old_value")
  newValue    String?  @map("new_value")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@map("ticket_activities")
}

// ============================================
// Engineer Tickets
// ============================================

model EngineerTicket {
  id            String       @id @default(uuid()) @db.Uuid
  ticketNumber  String       @unique @map("ticket_number")
  title         String?
  description   String?      @db.Text
  department    String?
  location      String?
  typeOfDamage  String       @map("type_of_damage")
  status        TicketStatus @default(NEW)
  adminNotes    String?      @map("admin_notes") @db.Text
  informationBy String?      @map("information_by")
  assignTo      String?      @map("assign_to")
  userId        String       @map("user_id") @db.Uuid
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  user       User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  images     EngineerTicketImage[]
  views      EngineerTicketView[]
  comments   EngineerTicketComment[]
  activities EngineerTicketActivity[]

  @@index([userId])
  @@index([status])
  @@index([ticketNumber])
  @@index([createdAt(sort: Desc)])
  @@map("engineer_tickets")
}

model EngineerTicketImage {
  id           String   @id @default(uuid()) @db.Uuid
  ticketId     String   @map("ticket_id") @db.Uuid
  imageUrl     String   @map("image_url")
  uploadedBy   String   @map("uploaded_by")
  isCompletion Boolean  @default(false) @map("is_completion")
  createdAt    DateTime @default(now()) @map("created_at")

  ticket EngineerTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("engineer_ticket_images")
}

model EngineerTicketView {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  viewedAt  DateTime @default(now()) @map("viewed_at")

  ticket EngineerTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ticketId, userId])
  @@index([userId])
  @@map("engineer_ticket_views")
}

model EngineerTicketComment {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  comment   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  ticket EngineerTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@map("engineer_ticket_comments")
}

model EngineerTicketActivity {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @map("ticket_id") @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  actionType  String   @map("action_type")
  oldValue    String?  @map("old_value")
  newValue    String?  @map("new_value")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  ticket EngineerTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([userId])
  @@map("engineer_ticket_activities")
}

// ============================================
// User Activity & Notifications
// ============================================

model UserActivity {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  action       String   // 'created_ticket', 'updated_status', 'commented', etc.
  ticketId     String?  @map("ticket_id") @db.Uuid
  ticketNumber String?  @map("ticket_number")
  ticketType   String?  @map("ticket_type") // 'IT' or 'ENGINEER'
  details      String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("user_activities")
}

model Notification {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  type         String   // 'assignment', 'comment', 'status_change', 'mention'
  ticketId     String?  @map("ticket_id") @db.Uuid
  ticketNumber String?  @map("ticket_number")
  ticketType   String?  @map("ticket_type") // 'IT' or 'ENGINEER'
  message      String   @db.Text
  read         Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// Security - Blocked IPs
// ============================================

model BlockedIP {
  id          String   @id @default(uuid()) @db.Uuid
  ipAddress   String   @unique @map("ip_address")
  reason      String   // 'too_many_failed_logins', 'manual_block'
  blockedAt   DateTime @default(now()) @map("blocked_at")
  expiresAt   DateTime @map("expires_at")
  failedCount Int      @default(0) @map("failed_count")

  @@index([ipAddress])
  @@index([expiresAt])
  @@map("blocked_ips")
}
